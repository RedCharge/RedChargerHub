<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ course.title }} - {{ course.code }} | RedCharger Resources</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f8fafc;
            touch-action: pan-x pan-y;
        }
        .redcharger-bg {
            background-color: #DC2626;
        }
        .redcharger-text {
            color: #DC2626;
        }
        .nav-active {
            color: #DC2626;
            font-weight: 700;
            border-bottom: 2px solid #DC2626;
        }
        
        .back-button {
            display: inline-flex;
            align-items: center;
            margin-bottom: 24px;
            color: #6b7280;
            font-weight: 500;
            transition: color 0.2s;
            text-decoration: none;
            cursor: pointer;
            padding: 8px 16px;
            border-radius: 8px;
            background: white;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }
        
        .back-button:hover {
            color: #374151;
            background: #f9fafb;
        }
        
        .video-scroll-container {
            display: flex;
            overflow-x: auto;
            gap: 16px;
            padding: 8px 0 24px;
            scrollbar-width: thin;
        }
        
        .video-scroll-container::-webkit-scrollbar {
            height: 8px;
        }
        
        .video-scroll-container::-webkit-scrollbar-track {
            background: #f1f5f9;
            border-radius: 4px;
        }
        
        .video-scroll-container::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 4px;
        }

        .video-card {
            flex: 0 0 300px;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            background: white;
            cursor: pointer;
            transition: transform 0.2s;
        }
        
        .video-card:hover {
            transform: translateY(-4px);
        }
        
        .video-thumbnail {
            width: 100%;
            height: 170px;
            background-size: cover;
            background-position: center;
            position: relative;
        }
        
        .video-play {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 60px;
            height: 60px;
            background: rgba(220, 38, 38, 0.9);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 1.5rem;
            opacity: 0;
            transition: opacity 0.3s;
        }
        
        .video-card:hover .video-play {
            opacity: 1;
        }
        
        .video-info {
            padding: 16px;
        }
        
        .video-title {
            font-weight: 600;
            margin-bottom: 8px;
            font-size: 0.95rem;
            line-height: 1.4;
            color: #1f2937;
        }
        
        .video-channel {
            font-size: 0.8rem;
            color: #6b7280;
        }
        
        .pdf-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 20px;
            margin-top: 24px;
        }
        
        .pdf-card {
            background: white;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
            cursor: pointer;
            text-decoration: none;
            color: inherit;
            display: block;
            border: 2px solid transparent;
        }
        
        .pdf-card:hover {
            transform: translateY(-4px);
            border-color: #dc2626;
            box-shadow: 0 8px 25px rgba(220, 38, 38, 0.15);
        }
        
        .pdf-preview {
            height: 180px;
            background: #fef2f2;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #dc2626;
            font-size: 3rem;
            position: relative;
            overflow: hidden;
        }
        
        .pdf-preview::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, rgba(220, 38, 38, 0.1) 0%, transparent 100%);
        }
        
        .pdf-info {
            padding: 16px;
        }
        
        .pdf-title {
            font-weight: 600;
            margin-bottom: 8px;
            font-size: 0.95rem;
            color: #1f2937;
        }
        
        .pdf-details {
            font-size: 0.8rem;
            color: #6b7280;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .view-btn {
            background: #dc2626;
            color: white;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 500;
            transition: background 0.2s;
        }
        
        .pdf-card:hover .view-btn {
            background: #b91c1c;
        }
        
        .video-modal, .pdf-modal {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.75);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 50;
            padding: 20px;
        }
        
        .video-modal.hidden, .pdf-modal.hidden {
            display: none;
        }
        
        .modal-content {
            background: white;
            border-radius: 12px;
            width: 100%;
            max-width: 900px;
            max-height: 90vh;
            overflow: hidden;
        }
        
        .pdf-modal .modal-content {
            max-width: 1000px;
            height: 90vh;
            display: flex;
            flex-direction: column;
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px 20px;
            border-bottom: 1px solid #e5e7eb;
        }
        
        .modal-body {
            flex: 1;
            overflow: auto;
        }
        
        /* Mobile Full Screen PDF Viewer */
        .mobile-pdf-viewer {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: white;
            z-index: 100;
            display: none;
            flex-direction: column;
            touch-action: none;
        }
        
        .mobile-pdf-viewer.active {
            display: flex;
        }
        
        .mobile-header {
            padding: 16px;
            background: white;
            border-bottom: 1px solid #e5e7eb;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: relative;
            z-index: 20;
        }
        
        .mobile-toolbar {
            padding: 16px;
            background: white;
            border-top: 1px solid #e5e7eb;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: relative;
            z-index: 20;
        }
        
        .mobile-viewer-content {
            flex: 1;
            overflow: hidden;
            background: #f1f5f9;
            position: relative;
            touch-action: none;
        }
        
        .pdf-canvas-container {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            overflow: hidden;
            touch-action: none;
        }
        
        .pdf-page {
            position: absolute;
            transform-origin: 0 0;
            transition: transform 0.1s ease;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            background: white;
        }
        
        .zoom-controls {
            position: absolute;
            bottom: 80px;
            right: 16px;
            display: flex;
            flex-direction: column;
            gap: 8px;
            z-index: 15;
        }
        
        .zoom-btn {
            width: 44px;
            height: 44px;
            background: white;
            border: 1px solid #d1d5db;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            font-weight: bold;
            color: #374151;
            cursor: pointer;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            touch-action: manipulation;
        }
        
        .zoom-btn:active {
            background: #f3f4f6;
        }
        
        .zoom-level {
            position: absolute;
            top: 16px;
            right: 16px;
            background: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 8px 12px;
            border-radius: 20px;
            font-size: 14px;
            z-index: 15;
            display: none;
        }
        
        .mobile-controls {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .mobile-control-btn {
            background: white;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            padding: 8px 12px;
            color: #374151;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
        }
        
        .mobile-page-info {
            font-size: 0.875rem;
            color: #6b7280;
            margin: 0 12px;
        }
        
        .pdf-download-btn {
            background: #dc2626;
            color: white;
            padding: 8px 16px;
            border-radius: 6px;
            font-size: 0.875rem;
            font-weight: 500;
            transition: background 0.2s;
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 6px;
            text-decoration: none;
        }
        
        .pdf-download-btn:hover {
            background: #b91c1c;
        }
        
        .pdf-loading {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            color: #6b7280;
        }
        
        .pdf-error {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            text-align: center;
            padding: 20px;
            color: #dc2626;
        }
        
        .pdf-error-actions {
            margin-top: 16px;
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
            justify-content: center;
        }
        
        .pdf-viewer-container {
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
        }
        
        .pdf-viewer {
            flex: 1;
            overflow: auto;
            padding: 20px;
            background: #f1f5f9;
        }
        
        @media (max-width: 768px) {
            .pdf-grid {
                grid-template-columns: repeat(auto-fill, minmax(100%, 1fr));
            }
            
            .video-card {
                flex: 0 0 260px;
            }
        }

        /* Mobile PDF specific styles */
        .pdf-page {
            display: block;
            max-width: 100%;
            height: auto;
            -webkit-user-select: none;
            user-select: none;
            -webkit-touch-callout: none;
            -webkit-tap-highlight-color: transparent;
        }

        #pdfCanvasContainer {
            position: relative;
            width: 100%;
            height: 100%;
            overflow: hidden;
            background: #f8fafc;
            -webkit-overflow-scrolling: touch;
        }

        /* Prevent text selection and context menu */
        #pdfCanvasContainer * {
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
        }

        /* Improve touch interactions */
        #pdfCanvasContainer {
            touch-action: pan-x pan-y;
        }
    </style>
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
    <script src="https://www.youtube.com/iframe_api"></script>
    <!-- PDF.js for rendering PDFs -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.min.js"></script>
</head>
<body class="min-h-screen flex flex-col">
    <!-- Header -->
    <header class="sticky top-0 bg-white shadow-md z-10">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4 flex justify-between items-center">
            <div class="flex items-center space-x-2">
                <svg class="h-6 w-6 redcharger-text" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path>
                </svg>
                <h1 class="text-xl font-extrabold text-gray-900">RedCharger</h1>
            </div>
            <nav class="hidden md:flex space-x-8">
                <a href="/" class="text-gray-500 hover:redcharger-text transition duration-150 py-1">Home</a>
                <a href="/course" class="text-gray-500 hover:redcharger-text transition duration-150 py-1">Courses</a>
                <a href="/timetable" class="text-gray-500 hover:redcharger-text transition duration-150 py-1">Timetable</a>
                <a href="/resources" class="nav-active text-gray-500 hover:redcharger-text transition duration-150 py-1">Resources</a>
                <a href="/quizzes" class="text-gray-500 hover:redcharger-text transition duration-150 py-1">Quizzes</a>
            </nav>
        </div>
    </header>

    <main class="flex-1 max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8 w-full">
        <a href="/resources" class="back-button">
            <i data-lucide="arrow-left" class="w-5 h-5 mr-2"></i>
            Back to All Courses
        </a>
        
        <!-- Course Header -->
        <div class="mb-8">
            <h1 class="text-3xl font-bold text-gray-800 mb-2">{{ course.title }}</h1>
            <p class="text-gray-600">{{ course.code }}</p>
        </div>

        <!-- YouTube Videos Section -->
        <div class="mb-12">
            <h2 class="text-2xl font-bold text-gray-800 mb-4">Learning Videos</h2>
            <div class="video-scroll-container">
                {% for video in course.videos %}
                <div class="video-card" onclick="openVideoModal('{{ video.id }}', '{{ video.title }}')">
                    <div class="video-thumbnail" style="background-image: url(https://img.youtube.com/vi/{{ video.id }}/hqdefault.jpg)">
                        <div class="video-play">
                            <i data-lucide="play" class="w-6 h-6"></i>
                        </div>
                    </div>
                    <div class="video-info">
                        <div class="video-title">{{ video.title }}</div>
                        <div class="video-channel">{{ video.channel }}</div>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>

        <!-- PDF Resources Section -->
        <div>
            <h2 class="text-2xl font-bold text-gray-800 mb-4">Study Materials & PDFs</h2>
            
            <div class="pdf-grid">
                {% for pdf in course.pdfs %}
                <div class="pdf-card" onclick="openPdf('{{ pdf.url }}', '{{ pdf.title }}', '{{ pdf.size }}')">
                    <div class="pdf-preview">
                        <i data-lucide="file-text" class="w-16 h-16"></i>
                    </div>
                    <div class="pdf-info">
                        <div class="pdf-title">{{ pdf.title }}</div>
                        <div class="pdf-details">
                            <span>{{ pdf.size }}</span>
                            <span class="view-btn">View</span>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
    </main>

    <!-- Video Modal -->
    <div id="videoModal" class="video-modal hidden">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="modalVideoTitle" class="text-lg font-semibold">Video Title</h3>
                <button onclick="closeVideoModal()" class="text-gray-500 hover:text-gray-700">
                    <i data-lucide="x" class="w-6 h-6"></i>
                </button>
            </div>
            <div class="modal-body">
                <div id="videoPlayer" class="w-full h-64 md:h-96 bg-gray-900"></div>
            </div>
        </div>
    </div>

    <!-- PDF Modal (for desktop) -->
    <div id="pdfModal" class="pdf-modal hidden">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="modalPdfTitle" class="text-lg font-semibold">PDF Title</h3>
                <button onclick="closePdfModal()" class="text-gray-500 hover:text-gray-700">
                    <i data-lucide="x" class="w-6 h-6"></i>
                </button>
            </div>
            <div class="modal-body">
                <div class="pdf-viewer-container">
                    <div class="pdf-viewer" id="pdfViewerContainer">
                        <!-- PDF content will be loaded here -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Mobile Full Screen PDF Viewer with Zoom -->
    <div id="mobilePdfViewer" class="mobile-pdf-viewer">
        <div class="mobile-header">
            <h3 id="mobilePdfTitle" class="text-lg font-semibold truncate flex-1 mr-4">PDF Title</h3>
            <button onclick="closeMobilePdfViewer()" class="text-gray-500 hover:text-gray-700">
                <i data-lucide="x" class="w-6 h-6"></i>
            </button>
        </div>
        
        <div class="mobile-viewer-content">
            <div class="zoom-level" id="zoomLevel">100%</div>
            <div class="pdf-canvas-container" id="pdfCanvasContainer">
                <!-- PDF pages will be rendered here -->
            </div>
            <div class="zoom-controls">
                <button class="zoom-btn" onclick="zoomOut()">-</button>
                <button class="zoom-btn" onclick="zoomIn()">+</button>
                <button class="zoom-btn" onclick="resetZoom()" style="font-size: 14px; background: #dc2626; color: white; border-color: #dc2626;">View PDF</button>
            </div>
        </div>
        
        <div class="mobile-toolbar">
            <div class="mobile-controls">
                <button id="mobilePdfPrev" class="mobile-control-btn" onclick="previousPage()">
                    <i data-lucide="chevron-left" class="w-4 h-4"></i>
                    Prev
                </button>
                <span id="mobilePageInfo" class="mobile-page-info">Page 1 of 1</span>
                <button id="mobilePdfNext" class="mobile-control-btn" onclick="nextPage()">
                    Next
                    <i data-lucide="chevron-right" class="w-4 h-4"></i>
                </button>
            </div>
            <a id="mobilePdfDownload" href="#" download class="pdf-download-btn">
                <i data-lucide="download" class="w-4 h-4"></i>
                Download
            </a>
        </div>
    </div>

    <script>
    lucide.createIcons();
    
    // PDF Viewer State
    let pdfState = {
        pdfDoc: null,
        currentPage: 1,
        totalPages: 1,
        scale: 1.0,
        minScale: 0.5,
        maxScale: 5.0,
        zoomStep: 0.3,
        isDragging: false,
        startX: 0,
        startY: 0,
        scrollLeft: 0,
        scrollTop: 0,
        lastTouchDistance: 0,
        lastTap: 0,
        devicePixelRatio: window.devicePixelRatio || 1
    };

    // Global variable to track current PDF
    let currentPdf = {
        url: '',
        title: ''
    };

    // Desktop PDF State
    let desktopPdfState = {
        pdfDoc: null,
        currentPage: 1,
        totalPages: 1,
        scale: 1.5
    };

    function openVideoModal(videoId, videoTitle) {
        document.getElementById('modalVideoTitle').textContent = videoTitle;
        
        const videoPlayer = document.getElementById('videoPlayer');
        videoPlayer.innerHTML = `<div id="player"></div>`;
        
        new YT.Player('player', {
            height: '100%',
            width: '100%',
            videoId: videoId,
            playerVars: {
                'playsinline': 1,
                'rel': 0
            }
        });
        
        document.getElementById('videoModal').classList.remove('hidden');
    }

    function closeVideoModal() {
        document.getElementById('videoModal').classList.add('hidden');
        const videoPlayer = document.getElementById('videoPlayer');
        videoPlayer.innerHTML = '';
    }

    function openPdf(pdfUrl, pdfTitle, pdfSize) {
        const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
        
        if (isMobile) {
            openMobilePdfViewer(pdfUrl, pdfTitle);
        } else {
            openDesktopPdfModal(pdfUrl, pdfTitle);
        }
    }

    function openDesktopPdfModal(pdfUrl, pdfTitle) {
        currentPdf.url = pdfUrl;
        currentPdf.title = pdfTitle;
        
        document.getElementById('modalPdfTitle').textContent = pdfTitle;
        
        const pdfContainer = document.getElementById('pdfViewerContainer');
        pdfContainer.innerHTML = `
            <div class="pdf-loading">
                <i data-lucide="loader" class="w-12 h-12 animate-spin mb-4"></i>
                <p>Loading PDF...</p>
            </div>
        `;
        lucide.createIcons();
        
        document.getElementById('pdfModal').classList.remove('hidden');
        
        // Use PDF.js for desktop
        initializeDesktopPdfJs(pdfUrl, pdfContainer);
    }

    function initializeDesktopPdfJs(pdfUrl, container) {
        // Set up PDF.js worker
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.worker.min.js';
        
        container.innerHTML = '';
        
        // Create navigation controls
        const navControls = document.createElement('div');
        navControls.className = 'flex justify-between items-center p-4 bg-gray-50 border-b';
        navControls.innerHTML = `
            <div class="flex items-center gap-4">
                <button id="desktopPdfPrev" class="mobile-control-btn" onclick="desktopPreviousPage()">
                    <i data-lucide="chevron-left" class="w-4 h-4"></i>
                    Previous
                </button>
                <span id="desktopPageInfo" class="mobile-page-info">Page 1 of 1</span>
                <button id="desktopPdfNext" class="mobile-control-btn" onclick="desktopNextPage()">
                    Next
                    <i data-lucide="chevron-right" class="w-4 h-4"></i>
                </button>
            </div>
            <div class="flex items-center gap-4">
                <button class="mobile-control-btn" onclick="desktopZoomOut()">
                    <i data-lucide="zoom-out" class="w-4 h-4"></i>
                </button>
                <span id="desktopZoomLevel" class="mobile-page-info">150%</span>
                <button class="mobile-control-btn" onclick="desktopZoomIn()">
                    <i data-lucide="zoom-in" class="w-4 h-4"></i>
                </button>
                <button class="mobile-control-btn" onclick="desktopResetZoom()">
                    <i data-lucide="refresh-ccw" class="w-4 h-4"></i>
                </button>
            </div>
        `;
        
        const viewer = document.createElement('div');
        viewer.className = 'pdf-viewer';
        viewer.id = 'desktopPdfViewer';
        viewer.style.overflow = 'auto';
        viewer.style.height = 'calc(100% - 80px)';
        viewer.style.padding = '20px';
        viewer.style.backgroundColor = '#f1f5f9';
        
        container.appendChild(navControls);
        container.appendChild(viewer);
        
        lucide.createIcons();
        
        pdfjsLib.getDocument(pdfUrl).promise.then(function(pdf) {
            desktopPdfState.pdfDoc = pdf;
            desktopPdfState.totalPages = pdf.numPages;
            desktopPdfState.currentPage = 1;
            
            updateDesktopPageInfo();
            renderDesktopPage();
        }).catch(error => {
            console.error('Desktop PDF.js failed:', error);
            showDesktopPdfError(container, pdfUrl);
        });
    }

    function renderDesktopPage() {
        if (!desktopPdfState.pdfDoc) return;
        
        const viewer = document.getElementById('desktopPdfViewer');
        viewer.innerHTML = '';
        
        desktopPdfState.pdfDoc.getPage(desktopPdfState.currentPage).then(function(page) {
            const viewport = page.getViewport({ scale: desktopPdfState.scale });
            
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            
            // Set canvas dimensions with high DPI support
            canvas.width = Math.floor(viewport.width * pdfState.devicePixelRatio);
            canvas.height = Math.floor(viewport.height * pdfState.devicePixelRatio);
            canvas.style.width = viewport.width + 'px';
            canvas.style.height = viewport.height + 'px';
            canvas.style.display = 'block';
            canvas.style.margin = '0 auto';
            canvas.style.boxShadow = '0 2px 8px rgba(0, 0, 0, 0.1)';
            canvas.style.backgroundColor = 'white';
            
            const renderContext = {
                canvasContext: ctx,
                viewport: viewport,
                transform: [pdfState.devicePixelRatio, 0, 0, pdfState.devicePixelRatio, 0, 0]
            };
            
            page.render(renderContext).promise.then(() => {
                viewer.appendChild(canvas);
                updateDesktopZoomLevel();
            });
        }).catch(error => {
            console.error('Desktop page rendering failed:', error);
        });
    }

    function desktopPreviousPage() {
        if (desktopPdfState.currentPage > 1) {
            desktopPdfState.currentPage--;
            renderDesktopPage();
            updateDesktopPageInfo();
        }
    }

    function desktopNextPage() {
        if (desktopPdfState.currentPage < desktopPdfState.totalPages) {
            desktopPdfState.currentPage++;
            renderDesktopPage();
            updateDesktopPageInfo();
        }
    }

    function desktopZoomIn() {
        desktopPdfState.scale = Math.min(desktopPdfState.scale + 0.2, 3.0);
        renderDesktopPage();
    }

    function desktopZoomOut() {
        desktopPdfState.scale = Math.max(desktopPdfState.scale - 0.2, 0.5);
        renderDesktopPage();
    }

    function desktopResetZoom() {
        desktopPdfState.scale = 1.5;
        renderDesktopPage();
    }

    function updateDesktopPageInfo() {
        document.getElementById('desktopPageInfo').textContent = 
            `Page ${desktopPdfState.currentPage} of ${desktopPdfState.totalPages}`;
        
        // Update button states
        const prevBtn = document.getElementById('desktopPdfPrev');
        const nextBtn = document.getElementById('desktopPdfNext');
        
        prevBtn.disabled = desktopPdfState.currentPage <= 1;
        nextBtn.disabled = desktopPdfState.currentPage >= desktopPdfState.totalPages;
        
        // Visual feedback for disabled state
        if (prevBtn.disabled) {
            prevBtn.style.opacity = '0.5';
            prevBtn.style.cursor = 'not-allowed';
        } else {
            prevBtn.style.opacity = '1';
            prevBtn.style.cursor = 'pointer';
        }
        
        if (nextBtn.disabled) {
            nextBtn.style.opacity = '0.5';
            nextBtn.style.cursor = 'not-allowed';
        } else {
            nextBtn.style.opacity = '1';
            nextBtn.style.cursor = 'pointer';
        }
    }

    function updateDesktopZoomLevel() {
        document.getElementById('desktopZoomLevel').textContent = 
            Math.round(desktopPdfState.scale * 100) + '%';
    }

    function showDesktopPdfError(container, pdfUrl) {
        container.innerHTML = `
            <div class="pdf-error">
                <i data-lucide="file-x" class="w-16 h-16 mb-4"></i>
                <h3 class="text-lg font-semibold mb-2">Unable to load PDF</h3>
                <p class="text-gray-600 mb-4">The PDF couldn't be loaded in the viewer.</p>
                <div class="pdf-error-actions">
                    <a href="${pdfUrl}" class="pdf-download-btn" target="_blank">
                        <i data-lucide="external-link" class="w-4 h-4"></i>
                        Open in Browser
                    </a>
                    <a href="${pdfUrl}" download class="pdf-download-btn" style="background: #10b981;">
                        <i data-lucide="download" class="w-4 h-4"></i>
                        Download PDF
                    </a>
                </div>
            </div>
        `;
        lucide.createIcons();
    }

    function openMobilePdfViewer(pdfUrl, pdfTitle) {
        console.log('Opening mobile PDF viewer for:', pdfUrl);
        
        document.getElementById('mobilePdfTitle').textContent = pdfTitle;
        document.getElementById('mobilePdfDownload').href = pdfUrl;
        
        const container = document.getElementById('pdfCanvasContainer');
        
        // Show loading screen and immediately start loading PDF
        container.innerHTML = `
            <div class="pdf-loading">
                <i data-lucide="loader" class="w-12 h-12 animate-spin mb-4"></i>
                <p>Loading PDF content...</p>
            </div>
        `;
        lucide.createIcons();
        
        document.getElementById('mobilePdfViewer').classList.add('active');
        
        // Store the PDF URL for later use
        currentPdf.url = pdfUrl;
        currentPdf.title = pdfTitle;
        
        // Load PDF immediately when viewer opens
        loadMobilePdf();
    }

    // Simple function to load mobile PDF
    function loadMobilePdf() {
        console.log('Loading mobile PDF:', currentPdf.url);
        
        const container = document.getElementById('pdfCanvasContainer');
        
        // Show loading indicator
        container.innerHTML = `
            <div class="pdf-loading">
                <i data-lucide="loader" class="w-12 h-12 animate-spin mb-4"></i>
                <p>Loading PDF content...</p>
            </div>
        `;
        lucide.createIcons();
        
        // Set up PDF.js worker
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.worker.min.js';
        
        // Load PDF with simple configuration
        pdfjsLib.getDocument({
            url: currentPdf.url,
            withCredentials: false
        }).promise.then(function(pdf) {
            console.log('PDF loaded successfully, total pages:', pdf.numPages);
            pdfState.pdfDoc = pdf;
            pdfState.totalPages = pdf.numPages;
            pdfState.currentPage = 1;
            pdfState.scale = 1.0; // Reset scale
            
            updatePageInfo();
            renderCurrentPage();
            setupTouchEvents();
            
        }).catch(function(error) {
            console.error('PDF loading failed:', error);
            showMobilePdfError(currentPdf.url);
        });
    }

    function renderCurrentPage() {
        if (!pdfState.pdfDoc) {
            console.log('No PDF document loaded');
            return;
        }
        
        console.log('Rendering page:', pdfState.currentPage);
        
        const container = document.getElementById('pdfCanvasContainer');
        container.innerHTML = '';
        
        pdfState.pdfDoc.getPage(pdfState.currentPage).then(function(page) {
            console.log('Page loaded, rendering...');
            
            const containerRect = container.getBoundingClientRect();
            const viewport = page.getViewport({ scale: 1.0 });
            
            // Calculate scale to fit container
            const baseScale = Math.min(
                containerRect.width / viewport.width,
                containerRect.height / viewport.height,
                1.5 // Max scale for initial view
            );
            
            const actualScale = pdfState.scale * baseScale;
            
            // Create canvas
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            const scaledViewport = page.getViewport({ scale: actualScale });
            
            // Set canvas dimensions
            canvas.width = Math.floor(scaledViewport.width * pdfState.devicePixelRatio);
            canvas.height = Math.floor(scaledViewport.height * pdfState.devicePixelRatio);
            canvas.style.width = scaledViewport.width + 'px';
            canvas.style.height = scaledViewport.height + 'px';
            
            canvas.className = 'pdf-page';
            
            // Center the canvas
            canvas.style.left = Math.max(0, (containerRect.width - scaledViewport.width) / 2) + 'px';
            canvas.style.top = Math.max(0, (containerRect.height - scaledViewport.height) / 2) + 'px';
            
            const renderContext = {
                canvasContext: ctx,
                viewport: scaledViewport,
                transform: [pdfState.devicePixelRatio, 0, 0, pdfState.devicePixelRatio, 0, 0]
            };
            
            // Render the page
            page.render(renderContext).promise.then(() => {
                console.log('Page rendered successfully');
                container.appendChild(canvas);
                updateZoomLevel();
                showZoomLevelTemporarily();
                
                // Force a reflow to ensure rendering
                setTimeout(() => {
                    canvas.style.transform = 'translateZ(0)';
                }, 100);
                
            }).catch(renderError => {
                console.error('Rendering promise failed:', renderError);
                showRenderError();
            });
            
        }).catch(error => {
            console.error('Page rendering failed:', error);
            showRenderError();
        });
        
        function showRenderError() {
            container.innerHTML = `
                <div class="pdf-error">
                    <i data-lucide="alert-circle" class="w-16 h-16 mb-4"></i>
                    <h3 class="text-lg font-semibold mb-2">Rendering Failed</h3>
                    <p class="text-gray-600 mb-4">Could not render PDF page.</p>
                    <button onclick="loadMobilePdf()" class="pdf-download-btn">
                        <i data-lucide="refresh-ccw" class="w-4 h-4"></i>
                        Try Again
                    </button>
                </div>
            `;
            lucide.createIcons();
        }
    }

    function setupTouchEvents() {
        const container = document.getElementById('pdfCanvasContainer');
        
        // Clear existing event listeners
        container.replaceWith(container.cloneNode(true));
        const newContainer = document.getElementById('pdfCanvasContainer');
        
        // Single touch for dragging
        newContainer.addEventListener('touchstart', handleTouchStart, { passive: false });
        newContainer.addEventListener('touchmove', handleTouchMove, { passive: false });
        newContainer.addEventListener('touchend', handleTouchEnd, { passive: false });
        
        // Double tap for zoom
        newContainer.addEventListener('touchend', handleDoubleTap, { passive: false });
        
        // Pinch to zoom
        newContainer.addEventListener('touchmove', handlePinchZoom, { passive: false });
    }

    function handleDoubleTap(e) {
        const currentTime = new Date().getTime();
        const tapLength = currentTime - pdfState.lastTap;
        
        if (tapLength < 300 && tapLength > 0) {
            // Double tap detected - toggle zoom
            if (pdfState.scale > 1.5) {
                resetZoom();
            } else {
                pdfState.scale = 2.5; // Zoom to a readable level
                renderCurrentPage();
                showZoomLevelTemporarily();
            }
            e.preventDefault();
        }
        pdfState.lastTap = currentTime;
    }

    function handleTouchStart(e) {
        if (e.touches.length === 1) {
            const touch = e.touches[0];
            pdfState.isDragging = true;
            pdfState.startX = touch.pageX;
            pdfState.startY = touch.pageY;
            
            const canvas = document.querySelector('.pdf-page');
            if (canvas) {
                pdfState.scrollLeft = parseInt(canvas.style.left) || 0;
                pdfState.scrollTop = parseInt(canvas.style.top) || 0;
            }
        } else if (e.touches.length === 2) {
            // Store initial distance for pinch zoom
            const touch1 = e.touches[0];
            const touch2 = e.touches[1];
            pdfState.lastTouchDistance = Math.hypot(
                touch2.pageX - touch1.pageX,
                touch2.pageY - touch1.pageY
            );
        }
    }

    function handleTouchMove(e) {
        if (!pdfState.isDragging && e.touches.length !== 2) return;
        
        if (e.touches.length === 1 && pdfState.isDragging) {
            const touch = e.touches[0];
            const deltaX = touch.pageX - pdfState.startX;
            const deltaY = touch.pageY - pdfState.startY;
            
            const canvas = document.querySelector('.pdf-page');
            if (canvas) {
                const newLeft = pdfState.scrollLeft + deltaX;
                const newTop = pdfState.scrollTop + deltaY;
                
                canvas.style.left = newLeft + 'px';
                canvas.style.top = newTop + 'px';
            }
            e.preventDefault();
        }
    }

    function handleTouchEnd(e) {
        pdfState.isDragging = false;
    }

    function handlePinchZoom(e) {
        if (e.touches.length === 2) {
            const touch1 = e.touches[0];
            const touch2 = e.touches[1];
            const currentDistance = Math.hypot(
                touch2.pageX - touch1.pageX,
                touch2.pageY - touch1.pageY
            );
            
            if (pdfState.lastTouchDistance > 0) {
                const zoomFactor = currentDistance / pdfState.lastTouchDistance;
                
                if (zoomFactor > 1.05) {
                    // Pinch out - zoom in
                    zoomIn();
                    pdfState.lastTouchDistance = currentDistance;
                } else if (zoomFactor < 0.95) {
                    // Pinch in - zoom out
                    zoomOut();
                    pdfState.lastTouchDistance = currentDistance;
                }
            }
            
            e.preventDefault();
        }
    }

    function zoomIn() {
        if (pdfState.scale < pdfState.maxScale) {
            pdfState.scale = Math.min(pdfState.scale + pdfState.zoomStep, pdfState.maxScale);
            renderCurrentPage();
            showZoomLevelTemporarily();
        }
    }

    function zoomOut() {
        if (pdfState.scale > pdfState.minScale) {
            pdfState.scale = Math.max(pdfState.scale - pdfState.zoomStep, pdfState.minScale);
            renderCurrentPage();
            showZoomLevelTemporarily();
        }
    }

    function resetZoom() {
        if (!pdfState.pdfDoc) {
            loadMobilePdf();
            return;
        }
        
        pdfState.scale = 1.0;
        renderCurrentPage();
        showZoomLevelTemporarily();
    }

    function updateZoomLevel() {
        const zoomLevel = document.getElementById('zoomLevel');
        zoomLevel.textContent = Math.round(pdfState.scale * 100) + '%';
    }

    function showZoomLevelTemporarily() {
        const zoomLevel = document.getElementById('zoomLevel');
        zoomLevel.style.display = 'block';
        updateZoomLevel();
        
        setTimeout(() => {
            zoomLevel.style.display = 'none';
        }, 1500);
    }

    function previousPage() {
        if (pdfState.currentPage > 1) {
            pdfState.currentPage--;
            renderCurrentPage();
            updatePageInfo();
        }
    }

    function nextPage() {
        if (pdfState.currentPage < pdfState.totalPages) {
            pdfState.currentPage++;
            renderCurrentPage();
            updatePageInfo();
        }
    }

    function updatePageInfo() {
        document.getElementById('mobilePageInfo').textContent = 
            `Page ${pdfState.currentPage} of ${pdfState.totalPages}`;
        
        // Update button states with better mobile styling
        const prevBtn = document.getElementById('mobilePdfPrev');
        const nextBtn = document.getElementById('mobilePdfNext');
        
        prevBtn.disabled = pdfState.currentPage <= 1;
        nextBtn.disabled = pdfState.currentPage >= pdfState.totalPages;
        
        // Visual feedback for disabled state
        if (prevBtn.disabled) {
            prevBtn.style.opacity = '0.5';
            prevBtn.style.cursor = 'not-allowed';
        } else {
            prevBtn.style.opacity = '1';
            prevBtn.style.cursor = 'pointer';
        }
        
        if (nextBtn.disabled) {
            nextBtn.style.opacity = '0.5';
            nextBtn.style.cursor = 'not-allowed';
        } else {
            nextBtn.style.opacity = '1';
            nextBtn.style.cursor = 'pointer';
        }
    }

    function showMobilePdfError(pdfUrl) {
        const container = document.getElementById('pdfCanvasContainer');
        container.innerHTML = `
            <div class="pdf-error">
                <i data-lucide="file-x" class="w-16 h-16 mb-4"></i>
                <h3 class="text-lg font-semibold mb-2">Unable to load PDF</h3>
                <p class="text-gray-600 mb-4">The PDF couldn't be loaded in the viewer.</p>
                <div class="pdf-error-actions">
                    <a href="${pdfUrl}" class="pdf-download-btn" target="_blank" style="background: #3b82f6;">
                        <i data-lucide="external-link" class="w-4 h-4"></i>
                        Open in Browser
                    </a>
                    <a href="${pdfUrl}" download class="pdf-download-btn" style="background: #10b981;">
                        <i data-lucide="download" class="w-4 h-4"></i>
                        Download PDF
                    </a>
                </div>
            </div>
        `;
        lucide.createIcons();
    }

    function closeMobilePdfViewer() {
        document.getElementById('mobilePdfViewer').classList.remove('active');
        document.getElementById('pdfCanvasContainer').innerHTML = '';
        // Reset PDF state
        pdfState = {
            pdfDoc: null,
            currentPage: 1,
            totalPages: 1,
            scale: 1.0,
            minScale: 0.5,
            maxScale: 5.0,
            zoomStep: 0.3,
            isDragging: false,
            startX: 0,
            startY: 0,
            scrollLeft: 0,
            scrollTop: 0,
            lastTouchDistance: 0,
            lastTap: 0,
            devicePixelRatio: window.devicePixelRatio || 1
        };
    }

    function closePdfModal() {
        document.getElementById('pdfModal').classList.add('hidden');
        document.getElementById('pdfViewerContainer').innerHTML = '';
        // Reset desktop PDF state
        desktopPdfState = {
            pdfDoc: null,
            currentPage: 1,
            totalPages: 1,
            scale: 1.5
        };
    }

    // Close modals when clicking outside
    document.getElementById('videoModal').addEventListener('click', function(e) {
        if (e.target === this) {
            closeVideoModal();
        }
    });
    
    document.getElementById('pdfModal').addEventListener('click', function(e) {
        if (e.target === this) {
            closePdfModal();
        }
    });

    // Close modals with Escape key
    document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape') {
            closeVideoModal();
            closePdfModal();
            closeMobilePdfViewer();
        }
    });

    // Handle orientation changes for mobile
    window.addEventListener('orientationchange', function() {
        // Re-render PDF on orientation change with a slight delay
        if (document.getElementById('mobilePdfViewer').classList.contains('active') && pdfState.pdfDoc) {
            setTimeout(() => {
                renderCurrentPage();
            }, 500);
        }
    });

    // Prevent default zoom behaviors
    document.addEventListener('touchstart', function(e) {
        if (e.target.closest('#pdfCanvasContainer') && e.touches.length > 1) {
            e.preventDefault();
        }
    }, { passive: false });

    // Improved mobile toolbar styling
    function optimizeMobileToolbar() {
        const toolbar = document.querySelector('.mobile-toolbar');
        const controls = document.querySelector('.mobile-controls');
        const downloadBtn = document.getElementById('mobilePdfDownload');
        
        if (window.innerWidth <= 480) {
            // Stack layout for very small screens
            toolbar.style.flexDirection = 'column';
            toolbar.style.gap = '12px';
            toolbar.style.padding = '12px';
            controls.style.width = '100%';
            controls.style.justifyContent = 'space-between';
            downloadBtn.style.width = '100%';
            downloadBtn.style.justifyContent = 'center';
            downloadBtn.style.padding = '12px';
        } else {
            // Side by side for larger mobile screens
            toolbar.style.flexDirection = 'row';
            toolbar.style.padding = '16px';
            controls.style.width = 'auto';
            downloadBtn.style.width = 'auto';
            downloadBtn.style.padding = '8px 16px';
        }
    }

    // Run optimization on load and resize
    window.addEventListener('load', optimizeMobileToolbar);
    window.addEventListener('resize', optimizeMobileToolbar);

    // Force high-quality rendering on mobile devices
    if (/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent)) {
        // Enable hardware acceleration
        const style = document.createElement('style');
        style.textContent = `
            .pdf-page {
                image-rendering: -webkit-optimize-contrast;
                image-rendering: crisp-edges;
                image-rendering: pixelated;
                transform: translateZ(0);
                -webkit-transform: translateZ(0);
            }
            #pdfCanvasContainer {
                -webkit-backface-visibility: hidden;
                -webkit-perspective: 1000;
            }
        `;
        document.head.appendChild(style);
    }
</script>
</body>
</html>